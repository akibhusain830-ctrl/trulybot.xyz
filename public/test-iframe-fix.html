<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>External Domain Test - Simulating Customer Website</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #f0f2f5;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .test-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
            text-align: center;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }
        
        .iframe-container {
            border: 3px solid #007bff;
            border-radius: 8px;
            margin: 20px 0;
            height: 500px;
            position: relative;
            overflow: hidden;
        }
        
        .iframe-test {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .url-display {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }

        h1 { color: #007bff; margin-bottom: 10px; }
        h2 { color: #495057; margin-top: 25px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîß External Domain Embedding Test</h1>
        <p>This page simulates embedding the Trulybot widget from an external customer website.</p>
        <p><strong>Testing the "refused to connect" issue fix</strong></p>
    </div>

    <div class="test-section">
        <h2>üìã Test 1: Direct Iframe Embedding</h2>
        <p>This directly embeds the <code>/embed</code> page in an iframe, similar to how the widget loads:</p>
        
        <div class="url-display">
            Loading: http://localhost:3000/embed?botId=demo
        </div>
        
        <div id="iframe-status" class="status info">
            ‚è≥ Loading iframe...
        </div>
        
        <div class="iframe-container">
            <iframe 
                id="embed-iframe"
                class="iframe-test" 
                src="http://localhost:3000/embed?botId=demo"
                title="Trulybot Embed Test">
            </iframe>
        </div>
    </div>

    <div class="test-section">
        <h2>ü§ñ Test 2: Widget Script Loading</h2>
        <p>This tests the complete widget loading process:</p>
        
        <div id="widget-status" class="status info">
            ‚è≥ Loading widget script...
        </div>
        
        <div class="url-display">
            Widget source: http://localhost:3000/widget.js
        </div>
    </div>

    <div class="test-section">
        <h2>üîç Debug Information</h2>
        <div id="debug-log" style="background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;">
            Initializing debug console...<br>
        </div>
    </div>

    <!-- Load the widget script -->
    <script 
        src="http://localhost:3000/widget.js" 
        data-bot-id="demo"
        data-position="right"
        data-color="#007bff"
        async>
    </script>

    <script>
        const debugLog = document.getElementById('debug-log');
        const iframeStatus = document.getElementById('iframe-status');
        const widgetStatus = document.getElementById('widget-status');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : '#74c0fc';
            debugLog.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span><br>`;
            debugLog.scrollTop = debugLog.scrollHeight;
        }
        
        // Test iframe loading
        const iframe = document.getElementById('embed-iframe');
        
        iframe.addEventListener('load', function() {
            log('‚úÖ Iframe loaded successfully!', 'success');
            iframeStatus.className = 'status success';
            iframeStatus.innerHTML = '‚úÖ Iframe loaded successfully! The "refused to connect" issue is fixed!';
        });
        
        iframe.addEventListener('error', function() {
            log('‚ùå Iframe failed to load', 'error');
            iframeStatus.className = 'status error';
            iframeStatus.innerHTML = '‚ùå Iframe failed to load - there may still be security header issues';
        });
        
        // Test widget loading
        let checkCount = 0;
        const maxChecks = 50;
        
        function checkWidget() {
            checkCount++;
            const container = document.getElementById('trulybot-widget-container');
            const button = document.getElementById('trulybot-launcher');
            
            if (container && button) {
                log('‚úÖ Widget loaded and created successfully!', 'success');
                widgetStatus.className = 'status success';
                widgetStatus.innerHTML = '‚úÖ Widget script loaded and chat button created successfully!';
                
                // Test click functionality
                button.addEventListener('click', function() {
                    log('üñ±Ô∏è Chat button clicked!');
                    setTimeout(function() {
                        const panel = document.getElementById('trulybot-panel');
                        if (panel && panel.style.opacity === '1') {
                            log('‚úÖ Chat panel opened successfully!', 'success');
                        }
                    }, 1000);
                });
                return;
            }
            
            if (checkCount >= maxChecks) {
                log('‚ùå Widget failed to load after ' + maxChecks + ' checks', 'error');
                widgetStatus.className = 'status error';
                widgetStatus.innerHTML = '‚ùå Widget script failed to load or initialize';
                return;
            }
            
            setTimeout(checkWidget, 100);
        }
        
        setTimeout(() => {
            log('üîç Starting widget detection...');
            checkWidget();
        }, 2000);
        
        // Enhanced error monitoring
        window.addEventListener('error', function(e) {
            log(`‚ùå JavaScript Error: ${e.message} (${e.filename}:${e.lineno})`, 'error');
        });

        // Monitor console for specific iframe issues
        const originalError = console.error;
        console.error = function(...args) {
            const message = args.join(' ');
            if (message.includes('refused to connect') || message.includes('X-Frame-Options')) {
                log(`üö´ Frame blocking detected: ${message}`, 'error');
                iframeStatus.className = 'status error';
                iframeStatus.innerHTML = '‚ùå Frame blocked by security headers: ' + message;
            }
            originalError.apply(console, args);
        };

        log('üöÄ Test initialized - monitoring iframe and widget loading...');
        log(`üìç Testing from origin: ${window.location.origin}`);
        log(`üéØ Target server: http://localhost:3000`);
    </script>
</body>
</html>